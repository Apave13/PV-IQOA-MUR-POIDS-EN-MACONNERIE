<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PV Visite IQOA - Mur Ma√ßonnerie</title>
    <style>
        /* ==========================================================================
           VARIABLES DE CONFIGURATION GLOBALE
           ========================================================================== */
        :root { 
            /* --- 1. COULEURS --- */
            --c-primaire: #1D3051;        /* Bleu principal Apave */
            --c-secondaire: #009A4D;      /* Vert (Boutons validation) */
            --c-alerte: #d32f2f;          /* Rouge (S√©curit√© S) */
            --c-orange: #f57c00;          /* Orange */
            --c-gris: #9e9e9e;            /* Gris */
            --c-fond-page: #f5f7fa;       
            --c-fond-boite: #ffffff;      
            --c-fond-header-tab: #f8fafc; 
            --c-fond-accordeon: #eef3f7;  
            --c-texte: #333333;           
            --c-texte-leger: #666666;     
            --c-bordure: #e1e4e8;         

            /* --- 2. TYPOGRAPHIE --- */
            --font-stack: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, "Arial", sans-serif;
            --taille-texte: 15px;         
            --taille-h1: 2.5rem;          
            --taille-h2: 1.8rem;          
            --taille-h3: 1.3rem;          
            --taille-h4: 1.1rem;
            
            /* CONFIGURATION TITRES A.1 - A.6 */
            --taille-titre-sections-A: 1.15rem;          
            --bg-titre-sections-A: #e9ecef; /* COULEUR DE FOND GRISE (Case) */

            /* --- 3. DIMENSIONS TABLEAUX --- */
            --w-col-code: 10%;            
            --w-col-libelle: 35%;         
            --w-col-classe: 15%;          
            --w-col-s: 8%;                
            --w-col-photo: 10%;           
            
            --w-print-col-defaut: 70%;    
            --w-print-col-classe: 15%;    
            --w-print-col-s: 15%;         
            
            --w-synth-libelle: 70%;       
            --w-synth-classe: 20%;        
            --w-synth-s: 10%;             

            /* --- 4. DIMENSIONS PHOTOS --- */
            --dim-vignette: 100px;        
            --dim-img-print-gen: 220px;   
            --dim-img-print-defaut: 120px;
            --dim-img-cover: 320px;       
            --esp-titre-cadre: 10px;      
            --esp-cadre-texte: 30px;      

            /* --- 5. DIMENSIONS BOUTONS & UI --- */
            --dim-btn-mini: 28px;         
            --pad-btn-principal: 18px;    
            --h-logo: 55px;

            /* --- 6. CONFIGURATION IMPRESSION (PDF) --- */
            --print-marge-haut: 20mm;
            --print-marge-bas: 15mm;
            --print-marge-gauche: 10mm;
            --print-marge-droite: 10mm;
            --print-break-section: always; 
        }

        /* --- CSS G√âN√âRAL --- */
        body { 
            font-family: var(--font-stack); 
            font-size: var(--taille-texte); 
            background: var(--c-fond-page); 
            margin: 0; padding: 0; 
            color: var(--c-texte); 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        .hidden { display: none !important; }
        .box { background: var(--c-fond-boite); padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* --- INTERFACE DE SAISIE --- */
        #section-formulaire { max-width: 900px; margin: 0 auto; padding: 20px; padding-bottom: 120px; }
        
        .header { 
            background: var(--c-primaire); color: white; padding: 20px; 
            border-radius: 12px; margin-bottom: 25px; text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative; display: flex; justify-content: space-between; align-items: center;
        }
        .header-text { flex-grow: 1; text-align: center; }
        .header h1 { margin: 0; font-size: var(--taille-h1); }
        .header p { margin: 5px 0 0; opacity: 0.9; font-size: 0.9em; } 
        .header-logo { height: var(--h-logo); background: white; padding: 4px; border-radius: 4px; margin-left: 15px; }
        
        /* STYLES ACCORDEON AMELIOR√âS */
        /* Application des variables aux titres du formulaire */
        h2.form-h2 {
            color: var(--c-primaire);
            font-size: var(--taille-h2); /* Variable H2 appliqu√©e */
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        /* Style sp√©cifique pour les titres A.1, A.2, etc. (MODIFI√â) */
        .form-sub-h4 {
            color: var(--c-primaire); 
            font-size: var(--taille-titre-sections-A); 
            background-color: var(--bg-titre-sections-A); /* Fond gris appliqu√© */
            margin-top: 20px; 
            margin-bottom: 10px;
            padding: 10px 15px; /* Padding pour effet boite */
            font-weight: 700; 
            border-radius: 6px; /* Bords arrondis */
        }

        h3.form-h3, h4.form-h4, h5.form-h5 {
            cursor: pointer; 
            user-select: none;
            transition: background-color 0.2s;
        }
        h3.form-h3:hover, h4.form-h4:hover, h5.form-h5:hover {
            opacity: 0.9;
        }

        h3.form-h3 {
            color: var(--c-texte); font-size: var(--taille-h3); /* Variable H3 appliqu√©e */ 
            margin-top: 20px; margin-bottom: 0; 
            background: var(--c-fond-accordeon); padding: 15px; border-radius: 6px; font-weight: 700; border-left: 5px solid var(--c-primaire);
            display: flex; align-items: center; gap: 10px;
        }

        h4.form-h4 {
            color: var(--c-primaire); font-size: var(--taille-h4); /* Variable H4 appliqu√©e */
            margin-top: 15px; margin-bottom: 5px;
            padding: 5px 10px; font-weight: 700; border-bottom: 1px solid #eee;
            display: flex; align-items: center; gap: 10px; 
        }
        
        h5.form-h5 {
            color: #555; font-size: 1.05em; 
            margin-top: 10px; margin-bottom: 5px;
            font-weight: 600; font-style: italic; display: flex; align-items: center; gap: 10px;
        }

        .toggle-status { font-family: monospace; font-weight: bold; font-size: 1.2rem; min-width: 20px; text-align: center; }

        .classe-badge {
            background: white; border: 1px solid var(--c-primaire); color: var(--c-primaire);
            padding: 2px 8px; border-radius: 4px; font-size: 0.9em; font-weight: bold;
            min-width: 30px; text-align: center; margin-left: auto;
        }
        .badge-s { color: var(--c-alerte); margin-left: 4px; }

        .section-content, .subsection-content { overflow: hidden; padding-top: 5px; margin-bottom: 10px; }
        
        /* C'est ici que l'on cache ce qui a la classe 'collapsed' */
        .section-content.collapsed, .subsection-content.collapsed, .iqoa-table.collapsed { display: none; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 600px) { 
            .grid-2 { grid-template-columns: 1fr; }
            .header { flex-direction: column-reverse; gap: 10px; }
            .header-logo { margin-left: 0; }
        }

        label.titre-champ { display: block; font-weight: 600; margin-top: 15px; margin-bottom: 5px; color: #444; font-size: var(--taille-texte); }
        
        input[type="text"], input[type="date"], input[type="number"], select, textarea { 
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: var(--taille-texte); 
        }

        /* TABLEAUX IQOA */
        .iqoa-table { width: 100%; border-collapse: collapse; margin-top: 5px; table-layout: fixed; margin-bottom: 15px; }
        .iqoa-table th { background: var(--c-fond-header-tab); text-align: left; font-size: 0.85em; color: #64748b; padding: 6px; border: 1px solid #ddd; }
        .iqoa-table td { padding: 6px; border: 1px solid #ddd; vertical-align: middle; font-size: 0.95em; }
        
        .mini-photo-btn {
            display: inline-block; background: #e9ecef; border: 1px solid #ced4da;
            border-radius: 50%; 
            width: var(--dim-btn-mini); height: var(--dim-btn-mini); line-height: var(--dim-btn-mini); 
            text-align: center; cursor: pointer; font-size: 12px;
        }
        .mini-photo-btn.has-photos { background: var(--c-secondaire); color: white; }
        .mini-photo-btn.loading { background: #ffc107; cursor: wait; }

        /* VIGNETTES PHOTOS */
        .preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 10px; }
        .large-preview-grid { display: flex; gap: 10px; flex-wrap: wrap; padding: 5px; }
        .large-thumb { width: var(--dim-vignette); height: var(--dim-vignette); object-fit: cover; border-radius: 6px; border: 1px solid #ccc; cursor: pointer; }
        .large-thumb:hover { opacity: 0.7; }
        .photo-row td { background-color: #f8fafc; padding: 10px; }

        .btn-generate {
            display: block; width: 100%; background: var(--c-secondaire); color: white; border: none; padding: var(--pad-btn-principal);
            font-size: 1.1rem; font-weight: bold; border-radius: 12px; margin-top: 30px; cursor: pointer;
        }

        /* --- RAPPORT PDF --- */
        #section-rapport { background: white; min-height: 100vh; display: none; font-size: var(--taille-texte); }
        
        .report-page-container {
            padding: var(--print-marge-haut) var(--print-marge-droite) var(--print-marge-bas) var(--print-marge-gauche);
            box-sizing: border-box;
            background: white;
            min-height: 297mm;
        }

        /* STYLE PAGE DE GARDE */
        .cover-page {
            position: relative;
            min-height: calc(297mm - var(--print-marge-haut) - var(--print-marge-bas));
            width: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow: hidden; 
            padding: var(--print-marge-haut) var(--print-marge-droite) var(--print-marge-bas) var(--print-marge-gauche);
            box-sizing: border-box;
        }
        .cover-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .cover-logo img { width: 180px; }
        .cover-client-date { font-size: 1.2em; color: #333; }
        .cover-title { text-align: center; margin-top: 10px; margin-bottom: 10px; color: var(--c-primaire); }
        .cover-title h1 { 
            font-size: var(--taille-h1); 
            font-weight: 800; 
            margin: 0; 
            line-height: 1.2; 
            text-transform: uppercase; 
        }
        .cover-photo {
            display: flex; justify-content: center; align-items: center;
            margin-top: var(--esp-titre-cadre); margin-bottom: var(--esp-cadre-texte);
            overflow: hidden; height: var(--dim-img-cover); 
            border: 1px solid #eee; background-color: #f9f9f9;
        }
        .cover-photo-img { width: auto; height: auto; max-width: 100%; max-height: 100%; object-fit: contain; }
        .cover-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 20px; border-top: 5px solid var(--c-primaire); padding-top: 20px; }
        .cover-info { font-size: 1.1em; line-height: 1.6; color: #333; display: flex; flex-direction: column; gap: 5px; }
        .cover-info strong { color: var(--c-primaire); display: inline-block; width: 160px; }
        .cover-right-block { display: flex; flex-direction: column; align-items: flex-end; gap: 30px; }
        .cover-note { text-align: center; }
        .cover-note-label { display: block; font-size: 1.3em; font-weight: bold; color: var(--c-primaire); margin-bottom: 10px; }
        .cover-note-value { display: inline-block; font-size: 2.5em; font-weight: 800; color: white; padding: 10px 40px; border-radius: 12px; background-color: var(--c-gris); }
        .cover-inspector { text-align: right; border-left: 3px solid var(--c-primaire); padding-left: 15px; }
        .cover-inspector-label { font-size: 1em; font-weight: bold; color: var(--c-primaire); text-transform: uppercase; margin-bottom: 5px; display: block; }
        .cover-inspector-name { font-size: 1.2em; font-weight: 600; color: #333; }

        /* Styles rapport standard */
        .print-header { border-bottom: 2px solid var(--c-primaire); padding: 10px 0; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        .print-h2 { 
            background: #f0f2f5; 
            color: var(--c-primaire); 
            padding: 8px 15px; 
            font-size: var(--taille-h2); /* Variable H2 appliqu√©e au rapport */
            font-weight: bold; 
            border-left: 5px solid var(--c-primaire); 
            margin-bottom: 15px; 
            margin-top: 30px; 
        }
        
        .print-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; table-layout: fixed; }
        .print-table th, .print-table td { border: 1px solid #ccc; padding: 6px; text-align: left; vertical-align: top; word-wrap: break-word; }
        .print-table th { background: #eee; }
        
        .row-sub-h4 td { 
            background-color: var(--bg-titre-sections-A); /* MODIF: Utilisation variable fond */
            font-weight: 700; 
            color: var(--c-primaire); 
            border-top: 1px solid #ccc; 
            border-bottom: 1px solid #ccc; 
            padding: 8px 10px;
            font-size: var(--taille-titre-sections-A); /* MODIF: Utilisation variable taille */
        }
        
        .row-section-header td { 
            background-color: #dce4f2; 
            font-weight: bold; 
            text-transform: uppercase;
            font-size: var(--taille-h3); /* Variable H3 appliqu√©e au rapport (titres de section) */
        }
        
        .print-photos-2cols { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .print-img { width: 100%; height: var(--dim-img-print-gen); object-fit: contain; border: 1px solid #eee; }
        .print-defect-photos { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
        .print-defect-img { height: var(--dim-img-print-defaut); border: 1px solid #ccc; }

        .action-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; border-top: 1px solid #ccc; display: flex; gap: 15px; z-index: 1000; }
        .btn-action { flex: 1; padding: 15px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; text-align: center; color: white; }
        .btn-back { background: #6c757d; }
        .btn-print { background: var(--c-primaire); }

        @media print {
            @page { margin: 0; size: A4; }
            body { margin: 0; padding: 0; background: white; }
            /* FORCE L'IMPRESSION DES BACKGROUNDS */
            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            
            #section-formulaire, .action-bar { display: none !important; }
            #section-rapport { display: block !important; padding: 0; }
            .print-section { page-break-before: var(--print-break-section); page-break-inside: avoid; margin-bottom: 30px; }
            .report-page-container .print-section:first-child { page-break-before: auto; }
        }
    </style>
</head>
<body>

<div id="section-formulaire">
    <div class="header">
        <div style="width: 50px;" class="hidden-mobile"></div>
        <div class="header-text">
            <h1>IQOA - MUR POIDS EN MA√áONNERIE</h1>
            <p>Proc√®s-Verbal de Visite d'Inspection</p>
        </div>
        <img src="https://img.batiweb.com/repo-images/supplier/5820813/apave-logo.webp" alt="Logo APAVE" class="header-logo">
    </div>

    <!-- A. IDENTIFICATION -->
    <div class="box">
        <h2 class="form-h2">A. Identification & Rep√©rage</h2>
        
        <h4 class="form-sub-h4">A.1 Donn√©es Administratives</h4>
        <div class="grid-2">
            <div>
                <label class="titre-champ">Client / Ma√Ætre d'ouvrage</label>
                <input type="text" id="i_client" placeholder="Ex: DIR M√©diterran√©e">
            </div>
            <div>
                <label class="titre-champ">Date de visite</label>
                <input type="date" id="i_date">
            </div>
        </div>
        
        <label class="titre-champ">N¬∞ d'affaire</label>
        <input type="text" id="i_num_affaire" placeholder="Ex: 2023-XXXX">

        <div class="grid-2">
            <div>
                <label class="titre-champ">Identifiant Mur</label>
                <input type="text" id="i_id_mur" placeholder="Ex: M1001">
            </div>
            <div>
                <label class="titre-champ">Type de ma√ßonnerie</label>
                <select id="i_type_mac">
                    <option value="">-- S√©lectionner --</option>
                    <option value="Type 1 - Pierres S√®ches">Type 1 - Pierres S√®ches</option>
                    <option value="Type 2 - Ma√ßonnerie Jointoy√©e">Type 2 - Ma√ßonnerie Jointoy√©e</option>
                    <option value="Mixte">Mixte</option>
                </select>
            </div>
        </div>
        
        <h4 class="form-sub-h4">A.2 Donn√©es de Localisation</h4>
        <div class="grid-2">
            <div>
                <label class="titre-champ">Coordonn√©es GPS</label>
                <input type="text" id="i_gps" placeholder="Latitude, Longitude">
            </div>
            <div>
                <label class="titre-champ">Voie port√©e / Voie Rattach√©e</label>
                <input type="text" id="i_voie" placeholder="Ex: RN 85 - PR 12+500">
            </div>
        </div>
        
        <label class="titre-champ">Voie Soutenue</label>
        <input type="text" id="i_voie_soutenue" placeholder="Ex: Chemin de randonn√©e ou voie communale">
        
        <label class="titre-champ">Intervenant(s)</label>
        <select id="i_intervenant">
            <option value="">-- S√©lectionner --</option>
            <option value="David YVON">David YVON</option>
            <option value="Caroline GAZULLA">Caroline GAZULLA</option>
            <option value="Tao CHEN">Tao CHEN</option>
            <option value="Jeremy CANDAELE">Jeremy CANDAELE</option>
            <option value="Cyril MARTEL">Cyril MARTEL</option>
        </select>
        
        <h4 class="form-sub-h4">A.3 Donn√©es d‚Äôusage</h4>
        <div class="grid-2">
            <div>
                <label class="titre-champ">Date de construction (Ann√©e)</label>
                <input type="number" id="i_date_construction" placeholder="Ex: 1985">
            </div>
            <div>
                <label class="titre-champ">Panneaux PTAC</label>
                <input type="text" id="i_panneaux_ptac" placeholder="Ex: 3.5T, 19T ou N/A">
            </div>
        </div>
        <label class="titre-champ">R√©seaux concessionnaires visibles</label>
        <input type="text" id="i_reseaux_visibles" placeholder="Ex: C√¢bles √©lectriques, conduites d'eau">
        
        <h4 class="form-sub-h4">A.4 Plan de localisation</h4>
        <label class="titre-champ">Observations Plan / Croquis</label>
        <textarea id="i_plan_localisation_obs" placeholder="Notes sur le plan de localisation"></textarea>
        
        <label class="titre-champ">Photos du Plan / Croquis</label>
        <input type="file" id="file_plan_localisation" accept="image/*" multiple onchange="handleImageUpload(this, 'grid_plan_localisation')">
        <div id="grid_plan_localisation" class="preview-grid"></div>

        <h4 class="form-sub-h4">A.5 Caract√©ristiques g√©n√©rales de l‚Äôouvrage</h4>
        <div class="grid-2">
            <div>
                <label class="titre-champ">Nature de l‚Äôouvrage</label>
                <input type="text" id="i_nature_ouvrage" placeholder="Nature">
            </div>
            <div>
                <label class="titre-champ">Largeur de la voie soutenue (m)</label>
                <input type="number" id="i_largeur_voie_soutenue" step="0.1">
            </div>
        </div>
        <div class="grid-2">
            <div>
                <label class="titre-champ">Hauteur moyenne (m)</label>
                <input type="number" id="i_hauteur_moyenne" step="0.1">
            </div>
            <div>
                <label class="titre-champ">Longueur totale (m)</label>
                <input type="number" id="i_longueur_totale" step="0.1">
            </div>
        </div>
        
        <h4 class="form-sub-h4">A.6 Vues g√©n√©rales</h4>
        <label class="titre-champ">Photos Vue G√©n√©rale</label>
        <input type="file" id="file_gene" accept="image/*" multiple onchange="handleImageUpload(this, 'grid_gene')">
        <div id="grid_gene" class="preview-grid"></div>
    </div>

    <!-- B. RELEV√â DES D√âSORDRES -->
    <div class="box">
        <h2 class="form-h2">B. Relev√© des D√©sordres</h2>
        <div id="dynamic-defects-container">
            <!-- Rempli par script -->
        </div>
    </div>

    <!-- C. SYNTH√àSE -->
    <div class="box">
        <h2 class="form-h2">C. Fiche de Synth√®se</h2>
        <label class="titre-champ">C. Observations de synth√®se & Conclusion (Pour le rapport)</label>
        <textarea id="i_synthese_obs" rows="5" placeholder="R√©sum√© global de l'√©tat de l'ouvrage..."></textarea>
    </div>

    <!-- D. NON VISITE -->
    <div class="box">
        <h2 class="form-h2">D. Partie Non Visit√©e de l‚ÄôOuvrage</h2>
        <label class="titre-champ">Observations / Justifications</label>
        <textarea id="i_non_visitee_obs" placeholder="Zones inaccessibles, justifications..."></textarea>
        <label class="titre-champ">Photos zones non visit√©es</label>
        <input type="file" id="file_non_visitee" accept="image/*" multiple onchange="handleImageUpload(this, 'grid_non_visitee')">
        <div id="grid_non_visitee" class="preview-grid"></div>
    </div>

    <!-- E. ANALYSE ET RECOMMANDATIONS -->
    <div class="box">
        <h2 class="form-h2">E. Analyse et Recommandations</h2>
        <label class="titre-champ">Analyse technique et pr√©conisations de travaux</label>
        <textarea id="i_analyse_obs" rows="6" placeholder="Saisissez ici votre analyse globale et les recommandations de maintenance ou r√©paration..."></textarea>
    </div>

    <button class="btn-generate" onclick="generateReport()">üìÑ G√âN√âRER LE RAPPORT FINAL</button>
</div>

<!-- SECTION 2: RAPPORT PDF -->
<div id="section-rapport">
    <div id="report-content-area"></div>
</div>

<!-- Barre d'action -->
<div id="action-bar" class="action-bar hidden">
    <button class="btn-action btn-back" onclick="editMode()">‚úèÔ∏è Modifier</button>
    <button class="btn-action btn-print" onclick="window.print()">üñ®Ô∏è Imprimer / PDF</button>
</div>

<script>
    // --- VARIABLES GLOBALES ---
    const photoStorage = {}; 
    const classOrder = { "": -1, "0": 0, "1": 1, "2": 2, "2E": 3, "3": 4, "3U": 5 };

    const codeLabelMap = {
        '1110': "Fissuration terrain // mur", '1111': "Fissuration en arc", '1112': "Tassement terrain amont", '1113': "D√©placement / Rotation", '1114': "Bourrelets de terrain", '1115': "√ârosions amont",
        '1120': "Inclinaison arbres amont", '1121': "V√©g√©tation amont", '1122': "Surcharges amont", '1123': "Structures voisines", '1124': "R√©seaux concessionnaires",
        '1210': "Fissuration terrain // mur (pied)", '1211': "Fissuration arc (pied)", '1212': "Tassement (pied)", '1213': "Bourrelets (pied)", '1214': "√ârosions (pied)",
        '1220': "Inclinaisons arbres (pied)", '1221': "V√©g√©tation (pied)", '1222': "Surcharges (pied)", '1223': "Structures voisines (pied)",
        '2110': "D√©formation chauss√©e", '2111': "Effondrement local", '2112': "Fissures transversales (I)", '2113': "Fissures longitudinales (II)", '2114': "Fissures longitudinales (III)", '2115': "Fissures longitudinales (IV)", '2116': "Fa√Øen√ßage", '2117': "Fissures transversales (II)", '2118': "Fissures en arc",
        '2120': "D√©fauts bordures / trottoirs", '2122': "Affaissement corps trottoir", '2123': "D√©faut √©tanch√©it√©", '2124': "Config. chauss√©e/accotement",
        '2130': "D√©placements / dislocations parapet", '2131': "D√©fauts alignement / renversement", '2132': "Alignement en √©l√©vation", '2133': "Joints dilatation / glissement", '2134': "D√©fauts mat√©riaux parapet", '2135': "Dispositif recueil EP",
        '2140': "D√©fauts plinthes / corniches", '2150': "D√©fauts signalisation / √©chelles / √©clairage",
        '2210': "Chauss√©e aval", '2211': "Effondrement aval", '2212': "Transversales aval", '2213': "Longitudinales aval", '2214': "Tassement aval", '2215': "Long. III aval", '2216': "Long. IV aval", '2217': "Trans. II aval", '2218': "Arc aval",
        '2220': "Bordures aval", '2221': "Affaissement aval", '2222': "Longitudinales aval", '2223': "Transversales aval", '2224': "Arc aval", '2230': "Retenue aval",
        '3110': "Zones humides / Suintements", '3111': "√âcoulement de fines", '3120': "Barbacanes alt√©r√©es / obstru√©es", '3121': "Absence de barbacanes / drains", '3122': "D√©gradation dispositif drainage",
        '3210': "Stagnation d'eau (sup)", '3211': "Obstruction √©vacuation (sup)", '3220': "D√©gradation collecte (sup)", '3221': "Alt√©ration joints cunette (sup)", '3222': "Encrassement cunette",
        '3310': "Stagnation d'eau (aval)", '3311': "Obstruction √©vacuation (aval)", '3312': "D√©gradation dispositif (aval)", '3320': "Collecte aval", '3321': "Alt√©ration joints cunette (aval)",
        '4110': "D√©versement vers l'aval", '4111': "D√©versement vers l'amont", '4112': "D√©formation en plan", '4113': "Pied d√©plac√© (glissement)", '4114': "D√©versement partie haute", '4115': "Pied d√©plac√© (tassement)", '4116': "Bombement", '4117': "Base du mur d√©plac√©e", '4118': "Basculement ou rotation",
        '4120': "Fractures verticales (I)", '4121': "Fractures verticales (II)", '4122': "Fractures verticales (III)", '4123': "D√©collement cha√Æne angle", '4124': "Fracture horizontale/oblique",
        '4130': "Disjointoiements", '4131': "Descellements / Lacunes", '4132': "Cavit√©s / Effondrements", '4133': "D√©sorganisation ma√ßonnerie", '4134': "D√©formation de pierres", '4135': "Alt√©ration des mortiers", '4136': "D√©sordres joints parement",
        '4210': "Affouillement (aquatique)", '4220': "Ravinements (terrestre)",
        '4310': "D√©solidarisation mur / contre-mur", '4311': "D√©versement CM aval", '4312': "D√©versement CM amont", '4313': "D√©formation plan CM", '4314': "D√©placement pied CM", '4315': "Tassement pied CM", '4316': "Bombement CM", '4317': "Rotation CM",
        '4320': "Fracture verticale I (CM)", '4321': "Fracture verticale II (CM)", '4322': "Fracture verticale III (CM)", '4323': "D√©collement angle (CM)", '4324': "Fracture horiz (CM)",
        '4410': "Tirant corrod√©", '4412': "Fondations (Encagement)", '4413': "Injection ma√ßonnerie", '4414': "Contrefort d√©coll√©", '4420': "Drainage r√©par√©", '4421': "Placage √©pingl√© d√©coll√©"
    };

    const fullStructure = [
        { id: "1", title: "1. ZONE D'INFLUENCE", subsections: [
            { id: "1.1", title: "1.1 En partie sup√©rieure du mur", groups: [
                { id: "111", title: "111 - Stabilit√© d'ensemble", codes: ['1110', '1111', '1112', '1113', '1114', '1115'] },
                { id: "112", title: "112 - Autres d√©fauts", codes: ['1120', '1121', '1122', '1123', '1124'] }
            ]},
            { id: "1.2", title: "1.2 En contrebas du mur", groups: [
                { id: "121", title: "121 - Stabilit√© d'ensemble", codes: ['1210', '1211', '1212', '1213', '1214'] },
                { id: "122", title: "122 - Autres d√©fauts", codes: ['1220', '1221', '1222', '1223'] }
            ]}
        ]},
        { id: "2", title: "2. √âQUIPEMENTS", subsections: [
            { id: "2.1", title: "2.1 Au-dessus du mur", groups: [
                { id: "211", title: "211 - Chauss√©e", codes: ['2110', '2111', '2112', '2113', '2114', '2115', '2116', '2117', '2118'] },
                { id: "212", title: "212 - Trottoirs / Bordures", codes: ['2120', '2122', '2123', '2124'] },
                { id: "213", title: "213 - Dispositifs de retenue", codes: ['2130', '2131', '2132', '2133', '2134', '2135'] },
                { id: "214", title: "214 - Plinthes / Corniches", codes: ['2140'] },
                { id: "215", title: "215 - Autres √©quipements", codes: ['2150'] }
            ]},
            { id: "2.2", title: "2.2 En contrebas du mur", groups: [
                { id: "221", title: "221 - Chauss√©e", codes: ['2210', '2211', '2212', '2213', '2214', '2215', '2216', '2217', '2218'] },
                { id: "222", title: "222 - Trottoirs / Bordures", codes: ['2220', '2221', '2222', '2223', '2224'] },
                { id: "223", title: "223 - Dispositifs retenue", codes: ['2230'] }
            ]}
        ]},
        { id: "3", title: "3. DRAINAGE", subsections: [
            { id: "3.1", title: "3.1 Interne au mur", groups: [
                { id: "311", title: "311 - Parement", codes: ['3110', '3111'] },
                { id: "312", title: "312 - Dispositif drainage", codes: ['3120', '3121', '3122'] }
            ]},
            { id: "3.2", title: "3.2 En partie sup√©rieure", groups: [
                { id: "321", title: "321 - √âvacuation", codes: ['3210', '3211'] },
                { id: "322", title: "322 - Collecte", codes: ['3220', '3221', '3222'] }
            ]},
            { id: "3.3", title: "3.3 En contrebas du mur", groups: [
                { id: "331", title: "331 - √âvacuation", codes: ['3310', '3311', '3312'] },
                { id: "332", title: "332 - Collecte", codes: ['3320', '3321'] }
            ]}
        ]},
        { id: "4", title: "4. STRUCTURE", subsections: [
            { id: "4.1", title: "4.1 Mur", groups: [
                { id: "411", title: "411 - Mouvements", codes: ['4110', '4111', '4112', '4113', '4114', '4115', '4116', '4117', '4118'] },
                { id: "412", title: "412 - Fractures", codes: ['4120', '4121', '4122', '4123', '4124'] },
                { id: "413", title: "413 - Mat√©riaux", codes: ['4130', '4131', '4132', '4133', '4134', '4135', '4136'] }
            ]},
            { id: "4.2", title: "4.2 Fondations", groups: [
                { id: "421", title: "421 - D√©fauts fondations", codes: ['4210', '4220'] }
            ]},
            { id: "4.3", title: "4.3 Contre-murs", groups: [
                { id: "431", title: "431 - Mouvements (CM)", codes: ['4310', '4311', '4312', '4313', '4314', '4315', '4316', '4317'] },
                { id: "432", title: "432 - Fractures (CM)", codes: ['4320', '4321', '4322', '4323', '4324'] }
            ]},
            { id: "4.4", title: "4.4 R√©parations et Renforcements", groups: [
                { id: "441", title: "441 - El√©ments ant√©rieurs", codes: ['4410', '4412', '4413', '4414'] },
                { id: "442", title: "442 - R√©parations", codes: ['4420', '4421'] }
            ]}
        ]}
    ];

    function getNoteColor(note) {
        if (!note || note === '-' || note === 'Non √©valu√©') return '#9e9e9e'; 
        if (note === '0' || note === '1') return '#009A4D'; 
        if (note === '2') return '#FBC02D'; 
        if (note === '2E') return '#F57C00'; 
        if (note === '3') return '#E64A19'; 
        if (note === '3U') return '#D32F2F'; 
        return '#9e9e9e';
    }

    function initForm() {
        const container = document.getElementById('dynamic-defects-container');
        fullStructure.forEach(section => {
            // Niveau 1 (1. Zone d'influence...)
            let html = `<h3 class="form-h3"><span class="toggle-status">-</span> ${section.title} <span class="classe-badge" id="synth_sec_${section.id}">-</span></h3>`;
            
            // MODIFICATION ICI : On enl√®ve la classe 'collapsed' pour que le contenu du niveau 1 soit visible par d√©faut
            html += `<div class="section-content">`; 
            
            section.subsections.forEach(sub => {
                // Niveau 2 (1.1 En partie sup√©rieure...) - On laisse ferm√©
                html += `<h4 class="form-h4"><span class="toggle-status">+</span> ${sub.title} <span class="classe-badge" id="synth_sub_${sub.id.replace('.','_')}">-</span></h4>`;
                html += `<div class="subsection-content collapsed">`;
                sub.groups.forEach(group => {
                    // Niveau 3 (111 - Stabilit√©...) - On laisse ferm√©
                    html += `<h5 class="form-h5"><span class="toggle-status">+</span> ${group.title} <span class="classe-badge" id="synth_grp_${group.id}">-</span></h5>`;
                    html += `<table class="iqoa-table collapsed"><thead><tr><th style="width:var(--w-col-code)">Code</th><th style="width:var(--w-col-libelle)">Libell√©</th><th style="width:var(--w-col-classe)">Classe</th><th style="width:var(--w-col-s)">S</th><th>Obs.</th><th style="width:var(--w-col-photo)">Photo</th></tr></thead><tbody>`;
                    group.codes.forEach(code => {
                        html += `<tr>
                            <td>${code}</td><td>${codeLabelMap[code] || "Inconnu"}</td>
                            <td><select id="c_${code}" class="class-select" data-group="${group.id}" data-sub="${sub.id}" data-section="${section.id}"><option value=""></option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="2E">2E</option><option value="3">3</option><option value="3U">3U</option></select></td>
                            <td><input type="checkbox" id="s_${code}" class="s-checkbox" data-group="${group.id}" data-sub="${sub.id}" data-section="${section.id}"></td>
                            <td><textarea id="o_${code}"></textarea></td>
                            <td><label class="mini-photo-btn" id="btn_${code}">üì∑<input type="file" class="hidden" accept="image/*" multiple onchange="handleImageUpload(this, 'grid_${code}')"></label></td>
                        </tr>
                        <tr id="row_grid_${code}" class="photo-row hidden"><td colspan="6"><div id="grid_${code}" class="large-preview-grid"></div></td></tr>`;
                    });
                    html += `</tbody></table>`;
                });
                html += `</div>`;
            });
            html += `</div>`;
            container.insertAdjacentHTML('beforeend', html);
        });

        document.querySelectorAll('.class-select, .s-checkbox').forEach(el => el.addEventListener('change', updateSynthesis));

        // Gestionnaire de clics
        container.addEventListener('click', function(e) {
            const header = e.target.closest('.form-h3, .form-h4, .form-h5');
            if (header) {
                const content = header.nextElementSibling;
                if (content) {
                    const isCollapsed = content.classList.toggle('collapsed');
                    const icon = header.querySelector('.toggle-status');
                    if (icon) icon.innerText = isCollapsed ? '+' : '-';
                }
            }
        });
    }

    function updateSynthesis() {
        fullStructure.forEach(section => {
            let secMaxRank = -1; let secMaxVal = "-"; let secHasS = false;
            section.subsections.forEach(sub => {
                let subMaxRank = -1; let subMaxVal = "-"; let subHasS = false;
                sub.groups.forEach(group => {
                    let grpMaxRank = -1; let grpMaxVal = "-"; let grpHasS = false;
                    group.codes.forEach(code => {
                        const val = document.getElementById('c_' + code).value;
                        const rank = classOrder[val] || -1;
                        if (rank > grpMaxRank) { grpMaxRank = rank; grpMaxVal = val; }
                        if (document.getElementById('s_' + code).checked) grpHasS = true;
                    });
                    document.getElementById('synth_grp_' + group.id).innerHTML = grpMaxVal === "-" ? "-" : (grpMaxVal + (grpHasS ? ' <span style="color:red">S</span>' : ''));
                    if (grpMaxRank > subMaxRank) { subMaxRank = grpMaxRank; subMaxVal = grpMaxVal; }
                    if (grpHasS) subHasS = true;
                });
                document.getElementById('synth_sub_' + sub.id.replace('.','_')).innerHTML = subMaxVal === "-" ? "-" : (subMaxVal + (subHasS ? ' <span style="color:red">S</span>' : ''));
                if (subMaxRank > secMaxRank) { secMaxRank = subMaxRank; secMaxVal = subMaxVal; }
                if (subHasS) secHasS = true;
            });
            document.getElementById('synth_sec_' + section.id).innerHTML = secMaxVal === "-" ? "-" : (secMaxVal + (secHasS ? ' <span style="color:red">S</span>' : ''));
        });
    }

    async function handleImageUpload(input, gridId) {
        if (!photoStorage[gridId]) photoStorage[gridId] = [];
        const btnId = input.closest('.mini-photo-btn')?.id || '';
        const btn = document.getElementById(btnId);
        if (btn) btn.classList.add('loading');
        const files = Array.from(input.files);
        for (const file of files) {
            const compressed = await compressImage(file);
            photoStorage[gridId].push(compressed);
        }
        renderGrid(gridId);
        if (btn) {
            btn.classList.remove('loading');
            btn.classList.add('has-photos');
        }
        input.value = ''; 
    }

    function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 1200;
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                };
            };
        });
    }

    function renderGrid(gridId) {
        const grid = document.getElementById(gridId);
        const row = document.getElementById('row_' + gridId);
        if (!grid) return;
        grid.innerHTML = '';
        const photos = photoStorage[gridId] || [];
        if (photos.length > 0) {
            row?.classList.remove('hidden');
            photos.forEach((src, idx) => {
                const img = document.createElement('img');
                img.src = src;
                img.className = 'large-thumb';
                img.onclick = () => { photoStorage[gridId].splice(idx, 1); renderGrid(gridId); };
                grid.appendChild(img);
            });
            document.getElementById('btn_' + gridId.replace('grid_', ''))?.classList.add('has-photos');
        } else {
            row?.classList.add('hidden');
            document.getElementById('btn_' + gridId.replace('grid_', ''))?.classList.remove('has-photos');
        }
    }

    window.generateReport = function() {
        try {
            const getVal = id => {
                const el = document.getElementById('i_' + id);
                return el ? el.value : "-";
            };

            // Changement du titre du document pour que le nom du fichier PDF soit l'identifiant
            const idMurVal = document.getElementById('i_id_mur').value;
            if(idMurVal && idMurVal.trim() !== "") {
                document.title = idMurVal;
            } else {
                document.title = "Rapport_IQOA_Anonyme";
            }

            const logoUrl = "https://img.batiweb.com/repo-images/supplier/5820813/apave-logo.webp";
            let globalMaxRank = -1;
            let globalNote = "Non √©valu√©";
            let globalHasS = false; 

            document.querySelectorAll('.class-select').forEach(sel => {
                const val = sel.value;
                const rank = classOrder[val] || -1;
                if (rank > globalMaxRank) { globalMaxRank = rank; globalNote = val; }
                const code = sel.id.replace('c_', '');
                const elS = document.getElementById('s_' + code);
                if(elS && elS.checked) globalHasS = true;
            });
            if (globalMaxRank === -1) globalNote = "Non √©valu√©";

            // PAGE DE GARDE
            let html = `<div class="cover-page">`;
            html += `<div class="cover-top">`;
            html += `<div><div class="cover-client-date"><strong>Client :</strong> ${getVal('client')}</div><div class="cover-client-date"><strong>Date :</strong> ${getVal('date')}</div></div>`;
            html += `<div class="cover-logo"><img src="${logoUrl}" alt="Logo Apave"></div>`;
            html += `</div>`;
            html += `<div class="cover-title"><h1>RAPPORT DE VISITE D'EVALUATION</h1></div>`;
            
            let coverImgHTML = `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#999; font-style:italic;">Pas de photo g√©n√©rale</div>`;
            if (photoStorage['grid_gene'] && photoStorage['grid_gene'].length > 0) {
                coverImgHTML = `<img src="${photoStorage['grid_gene'][0]}" class="cover-photo-img">`;
            }
            html += `<div class="cover-photo">${coverImgHTML}</div>`;
            
            html += `<div class="cover-footer">`;
            html += `<div class="cover-info">`;
            html += `<span class="cover-info-item"><strong>N¬∞ d'affaire :</strong> ${getVal('num_affaire')}</span>`;
            html += `<span class="cover-info-item"><strong>Identifiant :</strong> ${getVal('id_mur')}</span>`;
            html += `<span class="cover-info-item"><strong>Voie soutenue :</strong> ${getVal('voie_soutenue')}</span>`;
            html += `<span class="cover-info-item"><strong>Voie prot√©g√©e :</strong> ${getVal('voie')}</span>`;
            html += `</div>`;
            
            const noteDisplay = globalNote + (globalHasS ? ' S' : '');
            
            html += `<div class="cover-right-block">`;
            html += `<div class="cover-note">`;
            html += `<span class="cover-note-label">NOTE IQOA</span>`;
            html += `<span class="cover-note-value" style="background-color: ${getNoteColor(globalNote)};">${noteDisplay}</span>`;
            html += `</div>`;
            html += `<div class="cover-inspector">`;
            html += `<span class="cover-inspector-label">Inspecteur :</span>`;
            html += `<span class="cover-inspector-name">${getVal('intervenant')}</span>`;
            html += `</div>`;
            html += `</div></div>`; // FIN cover-page

            // RAPPORT
            html += `<div class="report-page-container">`;
            html += `<div class="print-header"><div style="flex-grow: 1;"></div></div>`;
            
            html += `<div class="print-section"><div class="print-h2">A. Identification</div><table class="print-table">`;
            html += `<tr class="row-sub-h4"><td colspan="4">A.1 Donn√©es Administratives</td></tr>`;
            html += `<tr><th width="25%">Client</th><td>${getVal('client')}</td><th width="25%">Date</th><td>${getVal('date')}</td></tr>`;
            html += `<tr><th>ID Mur</th><td>${getVal('id_mur')}</td><th>Type</th><td>${getVal('type_mac')}</td></tr>`;
            html += `<tr><th>Intervenant</th><td colspan="3">${getVal('intervenant')}</td></tr>`;
            html += `<tr class="row-sub-h4"><td colspan="4">A.2 Donn√©es de Localisation</td></tr>`;
            html += `<tr><th>Localisation GPS</th><td>${getVal('gps')}</td><th>Voie port√©e</th><td>${getVal('voie')}</td></tr>`;
            html += `<tr><th>Voie soutenue</th><td colspan="3">${getVal('voie_soutenue')}</td></tr>`;
            html += `<tr class="row-sub-h4"><td colspan="4">A.3 Donn√©es d‚Äôusage</td></tr>`;
            html += `<tr><th>Date construction</th><td>${getVal('date_construction')}</td><th>Panneaux PTAC</th><td>${getVal('panneaux_ptac')}</td></tr>`;
            html += `<tr><th>R√©seaux visibles</th><td colspan="3">${getVal('reseaux_visibles')}</td></tr>`;
            html += `</table>`; // Close table after A.3

            // A.4 Plan de localisation
            html += `<div style="background-color: var(--bg-titre-sections-A); font-weight: 700; color: var(--c-primaire); border: 1px solid #ccc; padding: 8px 10px; margin-bottom: 5px; font-size: var(--taille-titre-sections-A);">A.4 Plan de localisation</div>`;
            html += `<div style="margin-bottom: 10px;"><strong>Observations :</strong> ${getVal('plan_localisation_obs')}</div>`;
            html += `<div class="print-photos-2cols" id="p_grid_plan_localisation" style="margin-bottom: 15px;"></div>`;

            // A.5 Caract√©ristiques (New Table)
            html += `<table class="print-table">`;
            html += `<tr class="row-sub-h4"><td colspan="4">A.5 Caract√©ristiques g√©n√©rales de l‚Äôouvrage</td></tr>`;
            html += `<tr><th>Nature</th><td>${getVal('nature_ouvrage')}</td><th>Largeur voie</th><td>${getVal('largeur_voie_soutenue')} m</td></tr>`;
            html += `<tr><th>Hauteur moy.</th><td>${getVal('hauteur_moyenne')} m</td><th>Longueur tot.</th><td>${getVal('longueur_totale')} m</td></tr>`;
            html += `</table>`;

            // A.6 Vues g√©n√©rales
            html += `<div style="background-color: var(--bg-titre-sections-A); font-weight: 700; color: var(--c-primaire); border: 1px solid #ccc; padding: 8px 10px; margin-bottom: 5px; font-size: var(--taille-titre-sections-A);">A.6 Vues g√©n√©rales</div>`;
            html += `<div class="print-photos-2cols" id="p_grid_gene"></div>`;
            html += `</div>`;

            html += `<div class="print-section"><div class="print-h2">B. Relev√© des D√©sordres</div><table class="print-table"><tbody>`; 
            let hasB = false;
            const tableHeaderRow = `<tr style="background-color: var(--c-fond-header-tab); font-weight: bold; color: #64748b; font-size: 0.75rem;"><td style="width:var(--w-print-col-defaut)">D√©sordre / √âl√©ment</td><td style="width:var(--w-print-col-classe); text-align:center;">Classe</td><td style="width:var(--w-print-col-s); text-align:center;">S</td></tr>`;
            fullStructure.forEach(sec => {
                let secPrinted = false;
                sec.subsections.forEach(sub => {
                    let subPrinted = false;
                    sub.groups.forEach(grp => {
                        grp.codes.forEach(code => {
                            const cls = document.getElementById('c_' + code).value;
                            const obs = document.getElementById('o_' + code).value;
                            const secu = document.getElementById('s_' + code).checked;
                            const photos = photoStorage['grid_' + code] || [];
                            if (cls || obs.trim() !== "" || photos.length > 0) {
                                if (!secPrinted) { html += `<tr class="row-section-header"><td colspan="3">${sec.title}</td></tr>`; html += tableHeaderRow; secPrinted = true; }
                                if (!subPrinted) { html += `<tr class="row-sub-h4"><td colspan="3">${sub.title}</td></tr>`; subPrinted = true; }
                                hasB = true;
                                html += `<tr><td><strong>${code} - ${codeLabelMap[code]}</strong></td><td align="center"><strong>${cls || '-'}</strong></td><td align="center" style="color:red; font-weight:bold">${secu?'S':''}</td></tr>`;
                                if(photos.length > 0) {
                                    html += `<tr><td colspan="3"><div class="print-defect-photos">`;
                                    photos.forEach(p => html += `<img src="${p}" class="print-defect-img">`);
                                    html += `</div></td></tr>`;
                                }
                                if(obs.trim() !== "") html += `<tr><td colspan="3" style="padding:8px; font-style:italic; background-color:#f9f9f9;"><strong>Observations :</strong><br>${obs.replace(/\n/g, '<br>')}</td></tr>`;
                                html += `<tr><td colspan="3" style="border-left:none; border-right:none; height:20px;"></td></tr>`;
                            }
                        });
                    });
                });
            });
            if(!hasB) html += `<tr><td colspan="3" align="center">Aucun d√©sordre majeur relev√©.</td></tr>`;
            html += `</tbody></table></div>`;

            html += `<div class="print-section"><div class="print-h2">C. Fiche de Synth√®se</div>`;
            html += `<table class="print-table" style="border: 2px solid var(--c-primaire); width: 80%;">`;
            html += `<thead><tr><th style="width: var(--w-synth-libelle); background-color: var(--c-primaire); color: white;">√âl√©ments inspect√©s</th><th style="text-align:center; width: 10%; background-color: var(--c-primaire); color: white;">Classe</th><th style="text-align:center; width: 10%; background-color: var(--c-primaire); color: white;">S</th></tr></thead><tbody>`;
            fullStructure.forEach(sec => {
                const elSec = document.getElementById('synth_sec_' + sec.id);
                if (!elSec) return;
                const noteVal = elSec.innerHTML.replace(/<[^>]*>/g, '').replace('S', '').trim();
                const hasS = elSec.innerHTML.includes('color:red');
                html += `<tr style="background-color: #dce4f2; font-weight: bold;"><td>${sec.title}</td><td align="center">${noteVal}</td><td align="center" style="color:red; font-weight:bold;">${hasS ? 'S' : ''}</td></tr>`;
                sec.subsections.forEach(sub => {
                    const elSub = document.getElementById('synth_sub_' + sub.id.replace('.','_'));
                    if (!elSub) return;
                    const subVal = elSub.innerHTML.replace(/<[^>]*>/g, '').replace('S', '').trim();
                    const subS = elSub.innerHTML.includes('color:red');
                    html += `<tr style="background-color: #f0f4f8;"><td style="padding-left:15px;">${sub.title}</td><td align="center">${subVal}</td><td align="center" style="color:red; font-weight:bold;">${subS ? 'S' : ''}</td></tr>`;
                });
            });
            html += `</tbody></table>`;
            html += `<div style="margin-top: 15px; border: 2px solid var(--c-primaire); border-radius: 6px; overflow: hidden;"><div style="background-color: var(--c-primaire); color: white; padding: 8px 15px; font-weight: bold;">Observations & Conclusion G√©n√©rale</div><div style="padding: 15px; background: #fff; min-height: 80px;">${getVal('synthese_obs')}</div></div></div>`;
            
            const nonVisObs = getVal('non_visitee_obs');
            if (nonVisObs !== "-" || (photoStorage['grid_non_visitee'] && photoStorage['grid_non_visitee'].length > 0)) {
                html += `<div class="print-section"><div class="print-h2">D. Partie Non Visit√©e</div><table class="print-table"><tr><td>${nonVisObs}</td></tr></table><div class="print-photos-2cols" id="p_grid_non_visitee"></div></div>`;
            }

            const analyseObs = getVal('analyse_obs');
            html += `<div class="print-section"><div class="print-h2">E. ANALYSE ET RECOMMANDATIONS</div><div style="border: 2px solid var(--c-primaire); border-radius: 6px; padding: 15px; background: #fff; min-height: 80px;">${analyseObs}</div></div>`;
            html += `</div>`; 

            document.getElementById('report-content-area').innerHTML = html;
            setTimeout(() => {
                const render = (gridId, targetId) => {
                    const c = document.getElementById(targetId);
                    if(c) { c.innerHTML = ""; (photoStorage[gridId] || []).forEach(src => c.insertAdjacentHTML('beforeend', `<img src="${src}" class="print-img">`)); }
                };
                render('grid_plan_localisation', 'p_grid_plan_localisation');
                render('grid_gene', 'p_grid_gene');
                render('grid_non_visitee', 'p_grid_non_visitee');
            }, 100);

            document.getElementById('section-formulaire').classList.add('hidden');
            document.getElementById('section-rapport').style.display = 'block';
            document.getElementById('action-bar').classList.remove('hidden');
            window.scrollTo(0,0);
        } catch (e) {
            console.error(e);
            alert("Une erreur est survenue lors de la g√©n√©ration du rapport.");
        }
    }

    function editMode() {
        document.title = "PV Visite IQOA - Mur Ma√ßonnerie";
        document.getElementById('section-formulaire').classList.remove('hidden');
        document.getElementById('section-rapport').style.display = 'none';
        document.getElementById('action-bar').classList.add('hidden');
        window.scrollTo(0,0);
    }

    initForm();
</script>
</body>
</html>
